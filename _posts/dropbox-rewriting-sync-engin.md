---
title: Rewriting the heart of our sync engine
tags: 
    - python
    - dropbox
    - rust
    - file sync engine
---
> 本文翻译自[Dropbox 官方技术博客](https://dropbox.tech/)的一篇[Rewriting the heart of our sync engine](https://dropbox.tech/infrastructure/rewriting-the-heart-of-our-sync-engine)，这是关于他们怎么重写他们的文件同步引擎的技术博客，从问题到技术决策，再到问题推进落地，逻辑非常的严谨，我觉得非常值得我们国内的技术同僚借鉴。

在过去的四年中，我们一直在努力从头开始重建桌面客户端的同步引擎。 同步引擎是台式机上Dropbox文件夹背后的魔力，它是Dropbox上最古老，最重要的代码之一。 今天我们很自豪地宣布，我们已经将这个新的同步引擎（代号为“Nucleus”）交付给所有Dropbox用户。

重写同步引擎确实非常困难，我们不想盲目地庆祝它，因为在许多环境中，这将是一个糟糕的主意。 事实证明，这对于Dropbox来说是一个绝妙的主意，但这仅仅是因为我们对如何进行此过程非常谨慎。 特别是，我们将分享有关如何思考主要软件重写的思考，并重点介绍使该项目成功的关键举措，例如拥有非常干净的数据模型。

首先，让我们将时间回到2008年，即[Dropbox同步首次进入测试版](https://www.youtube.com/watch?v=7QmCUDHpNzE)的那一年。 乍一看，许多Dropbox同步看起来与今天相同。 用户安装Dropbox应用程序，该应用程序将在其计算机上创建一个魔术文件夹，并将文件放在该文件夹中会将它们同步到Dropbox服务器及其其他设备。 Dropbox服务器可持久安全地存储文件，并且可以在任何地方通过网络连接访问这些文件。

![01.png](https://dropbox.tech/cms/content/dam/dropbox/tech-blog/en-us/2020/03/01.png)
> 什么是同步引擎？ 同步引擎位于您的计算机上，可以协调将文件上传和下载到远程文件系统。

从那时起，我们将文件同步带到了很远。 我们从消费者开始同步同步其设备上适合自己使用的设备。 现在，我们的用户将Dropbox带到他们的工作中，在这里他们可以访问以公司共享层次结构组织的数百万个文件。 这些文件的内容通常远远超出其计算机的本地磁盘空间，并且它们现在可以使用 `Dropbox Smart Sync` 仅在需要时才下载文件。 Dropbox拥有数千亿个文件，数万亿个文件修订版和EB级客户数据。 用户可以通过成千上万个设备访问文件，这些设备都通过一个庞大的分布式系统联网。

## 大规模同步是困难的

大规模同步文件变得更加困难，理解为什么对理解我们决定重写的重要性很重要。 我们的第一个同步引擎，我们称为“经典版同步引擎”，其数据模型存在一些基本问题，仅在规模上出现，这些问题使得无法进行增量改进。

### 分布式系统是困难的

仅Dropbox的规模是一项艰巨的系统工程挑战。 但是撇开原始规模，文件同步是一个独特的分布式系统问题，因为允许客户端长时间脱机并在客户端返回时协调其更改。 网络分区是许多分布式系统算法的异常条件，但它们对我们来说是标准操作。

做到这一点很重要：用户信任Dropbox的最宝贵内容，并且确保其安全是不可商议的。 双向同步有很多特殊情况，而持久性比确保我们不删除或破坏服务器上的数据要难。 例如，经典版同步引擎在旧位置将移动表示为删除对，在新位置将其表示为添加。 考虑以下情况：由于短暂的网络故障，删除通过，但其相应的添加没有通过。 然后，即使服务器和其他设备仅在本地移动文件，用户仍会看到文件丢失。

### 什么地方都需要持久性是困难的

Dropbox的目标还在于无论用户的配置如何，“都能正常工作”。 我们支持 Windows，macOS 和 Linux，并且每个平台都具有各种文件系统，所有文件系统的行为略有不同。 在操作系统下，硬件存在巨大差异，用户还安装了不同的内核扩展或驱动程序，这些扩展程序或驱动程序会更改操作系统内的行为。 在Dropbox之上，应用程序都以不同的方式使用文件系统，并且依赖实际上可能不是其规范一部分的行为。

要保证在特定环境中的持久性，需要了解其实现，减轻其错误，甚至在调试生产问题时甚至对其进行逆向工程。 这些问题通常只在大量人群中出现，因为罕见的文件系统错误可能只影响一小部分用户。 因此，从根本上来说，在许多环境中“正常工作”和提供强大的耐用性保证是对立的。

### 测试文件同步是困难的
